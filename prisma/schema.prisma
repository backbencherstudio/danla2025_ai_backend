// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "./generated"
}

datasource db {
  provider = "postgresql"
}

enum Gender {
  MALE
  FEMALE
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
}

// nutrition and meal tracking enums

enum MealType {
  BREAKFAST
  LUNCH
  DINNER
  SNACK
}

enum SourceType {
  APP_RECIPE
  RESTAURANT
  CUSTOM
}

enum RestrictionType {
  INTOLERANCE
  DISLIKE
}

enum MoodLevel {
  LOW
  NEUTRAL
  HIGH
}

enum EnergyLevel {
  LOW
  NEUTRAL
  HIGH
}

enum DigestionLevel {
  POOR
  OK
  GOOD
}

enum AllergyType {
  PEANUTS
  TREE_NUTS
  DAIRY
  EGGS
  SOY
  WHEAT_GLUTEN
  FISH
}

enum CuisineType {
  ITALIAN
  MEXICAN
  JAPANESE
  THAI
  INDIAN
  MEDITERRANEAN
  AMERICAN
}

enum NutritionalPreferenceLevel {
  LOW
  MODERATE
  HIGH
}

model Account {
  id         String   @id @default(cuid())
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  user_id String
  user    User   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  type                String?
  provider            String?
  provider_account_id String?
  refresh_token       String?
  access_token        String?
  expires_at          DateTime?
  token_type          String?
  scope               String?
  id_token            String?
  session_state       String?

  @@unique([provider, provider_account_id])
  @@map("accounts")
}

model User {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?
  status     Int?      @default(1) @db.SmallInt

  approved_at  DateTime?
  availability String?

  email      String? @unique
  username   String? @unique
  name       String? @db.VarChar(255)
  first_name String? @db.VarChar(255)
  last_name  String? @db.VarChar(255)
  password   String? @db.VarChar(255)
  domain     String? @unique
  avatar     String?

  phone_number  String?
  country       String?
  state         String?
  city          String?
  address       String?
  zip_code      String?
  date_of_birth DateTime? @db.Date

  // nutrition profile
  gender         Gender?
  height_cm      Int?
  weight_kg      Decimal?
  age            Int?
  activity_level String?
  target_rate    Decimal?
  budget         Int?
  diet_goal_id   String?
  diet_plan_id   String?
  spice_level_id String?
  fitness_goal_id String?

  // nutritional preferences
  carbohydrates_pref  NutritionalPreferenceLevel? @default(MODERATE)
  sodium_pref         NutritionalPreferenceLevel? @default(MODERATE)
  fat_pref            NutritionalPreferenceLevel? @default(MODERATE)
  sugar_pref          NutritionalPreferenceLevel? @default(MODERATE)
  protein_pref        NutritionalPreferenceLevel? @default(MODERATE)
  kitchen_access      Boolean?
  meal_schedule       Json?
  notification_prefs  Json?
  trial_ends_at       DateTime?
  subscription_status String?

  // billing id. e.g. stripe customer id
  billing_id String?

  type              String?   @default("user")
  email_verified_at DateTime?

  is_two_factor_enabled Int?    @default(0)
  two_factor_secret     String? // secret key for two factor authentication

  accounts                  Account[]
  creator_conversations     Conversation[] @relation("creator")
  participant_conversations Conversation[] @relation("participant")
  receiver_messages         Message[]      @relation("receiver")
  sender_messages           Message[]      @relation("sender")
  receiver_notifications    Notification[] @relation("receiver")
  sender_notifications      Notification[] @relation("sender")

  user_payment_methods UserPaymentMethod[]
  user_settings        UserSetting[]
  ucodes               Ucode[]
  roles                Role[]
  role_users           RoleUser[]
  payment_transactions PaymentTransaction[]
  // nutrition relations
  fitness_goal      FitnessGoal?       @relation(fields: [fitness_goal_id], references: [id], onDelete: SetNull)
  diet_goal         DietGoal?          @relation(fields: [diet_goal_id], references: [id], onDelete: SetNull)
  diet_plan         DietPlan?          @relation(fields: [diet_plan_id], references: [id], onDelete: SetNull)
  spice_level       SpiceLevel?        @relation(fields: [spice_level_id], references: [id], onDelete: SetNull)
  allergies         UserAllergy[]
  cuisines          UserCuisine[]
  menu_item_matches MenuItemMatch[]
  meal_logs         MealLog[]
  daily_scores      ScoreDaily[]
  restaurant_visits LocationVisit[]

  @@map("users")
}

model Ucode {
  id         String   @id @default(cuid())
  created_at DateTime @default(now())
  updated_at DateTime @default(now())
  status     Int?     @default(1) @db.SmallInt

  user_id String?
  user    User?   @relation(fields: [user_id], references: [id])

  token      String?
  email      String?
  expired_at DateTime?

  @@map("ucodes")
}

model Role {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  status Int?    @default(1) @db.SmallInt
  title  String?
  name   String?

  user_id String?
  user    User?   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  permission_roles PermissionRole[]
  role_users       RoleUser[]
  permissions      Permission[]     @relation("PermissionToRole")

  @@map("roles")
}

model Permission {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  status     Int?    @default(1) @db.SmallInt
  title      String?
  action     String?
  subject    String?
  conditions String?
  fields     String?

  permission_roles PermissionRole[]
  roles            Role[]           @relation("PermissionToRole")

  @@map("permissions")
}

model PermissionRole {
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  permission_id String
  permission    Permission @relation(fields: [permission_id], references: [id], onDelete: Cascade)

  role_id String
  role    Role   @relation(fields: [role_id], references: [id], onDelete: Cascade)

  @@id([permission_id, role_id])
  @@map("permission_roles")
}

model RoleUser {
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  role_id String
  role    Role   @relation(fields: [role_id], references: [id], onDelete: Cascade)

  user_id String
  user    User   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@id([role_id, user_id])
  @@map("role_users")
}

// this table stores notification event
model NotificationEvent {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  status Int?    @default(1) @db.SmallInt
  type   String?
  text   String?

  notifications Notification[]

  @@map("notification_events")
}

model Notification {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  read_at DateTime?

  status Int? @default(1) @db.SmallInt

  sender_id String?
  sender    User?   @relation("sender", fields: [sender_id], references: [id])

  receiver_id String?
  receiver    User?   @relation("receiver", fields: [receiver_id], references: [id])

  notification_event_id String?
  notification_event    NotificationEvent? @relation(fields: [notification_event_id], references: [id])

  entity_id String?

  @@map("notifications")
}

model UserPaymentMethod {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  user_id String?
  user    User?   @relation(fields: [user_id], references: [id])

  payment_method_id String?
  checkout_id       String?

  @@map("user_payment_methods")
}

model PaymentTransaction {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  store_id String?

  user_id String?
  user    User?   @relation(fields: [user_id], references: [id])

  order_id         String?
  type             String?  @default("order")
  withdraw_via     String?  @default("wallet")
  provider         String?
  reference_number String?
  status           String?  @default("pending")
  raw_status       String?
  amount           Decimal?
  currency         String?
  paid_amount      Decimal?
  paid_currency    String?

  @@map("payment_transactions")
}

// message is used for conversation
model Message {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  status MessageStatus? @default(PENDING)

  sender_id String?
  sender    User?   @relation("sender", fields: [sender_id], references: [id])

  receiver_id String?
  receiver    User?   @relation("receiver", fields: [receiver_id], references: [id])

  conversation_id String?
  conversation    Conversation? @relation(fields: [conversation_id], references: [id], onDelete: Cascade)

  attachment_id String?
  attachment    Attachment? @relation(fields: [attachment_id], references: [id])

  message String?

  @@map("messages")
}

// this table stores attachment of message
model Attachment {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  name     String?
  type     String?
  size     Int?
  file     String?
  file_alt String?

  messages Message[]

  @@map("attachments")
}

// this table stores conversation
model Conversation {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  creator_id String?
  creator    User?   @relation("creator", fields: [creator_id], references: [id])

  participant_id String?
  participant    User?   @relation("participant", fields: [participant_id], references: [id])

  messages Message[]

  @@map("conversations")
}

// ---------End Chat schema---------

model Faq {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  status     Int?    @default(1) @db.SmallInt
  sort_order Int?    @default(0)
  question   String?
  answer     String?

  @@map("faqs")
}

model Contact {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  first_name   String?
  last_name    String?
  email        String?
  phone_number String?
  message      String?

  @@map("contacts")
}

model SocialMedia {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  status     Int?    @default(1) @db.SmallInt
  sort_order Int?    @default(0)
  name       String?
  url        String?
  icon       String?

  @@map("social_medias")
}

model WebsiteInfo {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  name                String?
  phone_number        String?
  email               String?
  address             String?
  logo                String?
  favicon             String?
  copyright           String?
  cancellation_policy String?

  @@map("website_infos")
}

model Setting {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  category      String?
  label         String?
  description   String?
  key           String? @unique
  default_value String?

  user_settings UserSetting[]

  @@map("settings")
}

model UserSetting {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  user_id String?
  user    User?   @relation(fields: [user_id], references: [id])

  setting_id String?
  setting    Setting? @relation(fields: [setting_id], references: [id])

  value String?

  @@map("user_settings")
}

// nutrition and meal tracking models
model FitnessGoal {
  id         String   @id @default(cuid())
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  title       String  @unique
  description String?
  icon        String?
  slug         String  @unique
  sort_order  Int?    @default(0)
  is_active   Boolean @default(true)

  users User[]

  @@map("fitness_goals")
}

model DietGoal {
  id         String   @id @default(cuid())
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  title       String  @unique
  description String?
  icon        String?
  slug         String  @unique
  sort_order  Int?    @default(0)
  is_active   Boolean @default(true)

  users User[]

  @@map("diet_goals")
}

model DietPlan {
  id         String   @id @default(cuid())
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  title       String  @unique
  description String?
  icon        String?
  slug         String  @unique
  sort_order  Int?    @default(0)
  is_active   Boolean @default(true)

  users User[]

  @@map("diets")
}

model Allergy {
  id         String   @id @default(cuid())
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  title       String  @unique
  description String?
  icon        String?
  slug         String  @unique
  sort_order  Int?    @default(0)
  is_active   Boolean @default(true)

  users UserAllergy[]

  @@map("allergies")
}

model UserAllergy {
  user_id    String
  user       User    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  allergy_id String
  allergy    Allergy @relation(fields: [allergy_id], references: [id], onDelete: Cascade)

  @@id([user_id, allergy_id])
  @@map("user_allergies")
}

model Cuisine {
  id         String   @id @default(cuid())
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  title       String  @unique
  description String?
  icon        String?
  slug         String  @unique
  sort_order  Int?    @default(0)
  is_active   Boolean @default(true)

  users UserCuisine[]

  @@map("cuisines")
}

model UserCuisine {
  user_id    String
  user       User    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  cuisine_id String
  cuisine    Cuisine @relation(fields: [cuisine_id], references: [id], onDelete: Cascade)

  @@id([user_id, cuisine_id])
  @@map("user_cuisines")
}

model SpiceLevel {
  id         String   @id @default(cuid())
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  title       String  @unique
  description String?
  icon        String?
  slug         String  @unique
  sort_order  Int?    @default(0)
  is_active   Boolean @default(true)

  users User[]

  @@map("spice_levels")
}


model Restaurant {
  id         String   @id @default(cuid())
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  name       String
  cuisine    String?
  price_tier Int?
  lat        Decimal?
  lng        Decimal?
  hours      Json?

  menu_items MenuItem[]
  visits     LocationVisit[]
  mealLogs   MealLog[]

  @@map("restaurants")
}

model MenuItem {
  id         String   @id @default(cuid())
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  name        String
  description String?
  cuisine     String?
  meal_type   MealType
  calories    Int
  protein     Int
  carbs       Int
  fat         Int
  tags        String[]
  allergens   String[]
  ingredients String[]
  source      SourceType

  restaurant_id String?
  restaurant    Restaurant? @relation(fields: [restaurant_id], references: [id])

  matches   MenuItemMatch[]
  meal_logs MealLog[]

  @@map("menu_items")
}

model MenuItemMatch {
  id         String   @id @default(cuid())
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  user_id      String
  user         User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  menu_item_id String
  menu_item    MenuItem @relation(fields: [menu_item_id], references: [id], onDelete: Cascade)

  match_score Int
  reasons     Json?
  avoid_flag  Boolean @default(false)

  @@unique([user_id, menu_item_id])
  @@map("menu_item_matches")
}

model MealLog {
  id         String   @id @default(cuid())
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  user_id String
  user    User   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  menu_item_id String?
  menu_item    MenuItem? @relation(fields: [menu_item_id], references: [id])

  custom_name  String?
  portion_size Decimal?
  portion_unit String?
  meal_type    MealType
  served_at    DateTime
  calories     Int
  protein      Int
  carbs        Int
  fat          Int
  source       SourceType

  restaurant_id String?
  restaurant    Restaurant? @relation(fields: [restaurant_id], references: [id])

  notes          String?
  feedback       Feedback?
  score          ScoreMeal?
  locationVisits LocationVisit[]

  @@map("meal_logs")
}

model Feedback {
  id         String   @id @default(cuid())
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  meal_log_id String  @unique
  meal_log    MealLog @relation(fields: [meal_log_id], references: [id], onDelete: Cascade)

  mood         MoodLevel?
  energy       EnergyLevel?
  digestion    DigestionLevel?
  taste_rating Int?
  notes        String?

  @@map("feedbacks")
}

model ScoreMeal {
  id         String   @id @default(cuid())
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  meal_log_id String  @unique
  meal_log    MealLog @relation(fields: [meal_log_id], references: [id], onDelete: Cascade)

  total_score     Int
  diet_compliance Int
  calorie_balance Int
  macro_balance   Int
  allergen_safety Int
  meal_timing     Int
  food_quality    Int
  mood_energy     Int

  @@map("score_meals")
}

model ScoreDaily {
  id         String   @id @default(cuid())
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  user_id String
  user    User   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  date            DateTime
  nai_score       Int
  diet_compliance Int
  calorie_balance Int
  macro_balance   Int
  allergen_safety Int
  meal_timing     Int
  food_quality    Int
  mood_energy     Int
  calorie_delta   Int?
  protein_delta   Int?
  flags           Json?

  @@unique([user_id, date])
  @@map("score_dailies")
}

model LocationVisit {
  id         String   @id @default(cuid())
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  user_id String
  user    User   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  restaurant_id String
  restaurant    Restaurant @relation(fields: [restaurant_id], references: [id], onDelete: Cascade)

  visited_at  DateTime
  meal_log_id String?
  meal_log    MealLog? @relation(fields: [meal_log_id], references: [id])

  @@map("location_visits")
}

// this table stores example
// model Note {
//   id                String  @id @default(cuid())
//   created_at DateTime  @default(now())
//   updated_at DateTime  @default(now())
//   deleted_at DateTime?
//   status     Int?      @default(1) @db.SmallInt

//   title String?
//   body  String? @db.Text

//   tenant_id Int?
//   tenant    Organization? @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
//   @@map("posts")
// }
